<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBASE NLQuery</title>
    <!-- Bootstrap CSS -->
    <link href="bootstrap.min.css" rel="stylesheet">
</head>
<style>
.notif-text:hover {
  cursor: pointer;
}
</style>
<body style="background-color: #0D1117;">
    <div class="container-fluid mt-4 mb-4 mx-auto px-4">
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <h5 class="notif-text text-decoration-underline" data-bs-toggle="collapse" data-bs-target="#apiCollapse" aria-expanded="false" aria-controls="apiCollapse">Click for prompt history</h5>
                </div>
                <div class="collapse mx-5" id="apiCollapse">     
                    <div class="card" id="chatSection">
                        
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center mb-4">
                    <img src="mbase_nlquery_logo.svg" alt="" style="max-width: 30%;">
                </div>
                <div class="alert alert-danger" role="alert" id="input_feedback" style="display: none;">
                    A simple danger alert with an example link. Give it a click if you like.
                </div>
                
                <h5><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-person" viewBox="0 0 16 16">
                    <path d="M11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2v9.255S12 12 8 12s-5 1.755-5 1.755V2a1 1 0 0 1 1-1h5.5z"/>
                  </svg> User Information
                </h5>
                
                <div>
                    <input class="form-control mb-2" type="text" placeholder="Username" aria-label="db_username" id="db_username">
                    <input class="form-control mb-2" type="password" placeholder="Password" aria-label="db_password" id="db_password">
                </div>
                <div class="form-floating">
                    <textarea class="form-control" placeholder="Prompt here..." id="nl_query" style="height: 100px" onkeyup="writingQuery(this)"></textarea>
                    <label for="nl_query">Prompt</label>  
                </div>
                <div class="form-check" data-bs-toggle="tooltip" data-bs-title="Checking this will prevent the NLQuery engine to execute the generated SQL.">
                    <input class="form-check-input" type="checkbox" value="" id="gen_only" checked>
                    <label class="form-check-label" for="gen_only">
                        Generate Only
                    </label>
                </div>
                <div class="form-check" data-bs-toggle="tooltip" data-bs-title="Checking this will supply the NLQuery engine with generated SQL history. May improve quality.">
                    <input class="form-check-input" type="checkbox" value="" id="remember_context">
                    <label class="form-check-label" for="remember_context">
                        Remember Context
                    </label>
                </div>

                <div class="d-flex mt-2">
                    <div class="p-2">
                        
                    </div>
                    <div class="ms-auto p-2">
                        <button class="btn btn-default disabled" onclick="sendQueryRequest()" id="sendQueryButton">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-arrow-up-circle" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 bd-info">
                <div class="text-center">
                    <h5 class="notif-text text-decoration-underline" data-bs-toggle="collapse" data-bs-target="#disclaimerCollapse" aria-expanded="false" aria-controls="disclaimerCollapse">Click for Disclaimer</h5>
                </div>
                <div class="collapse mx-5" id="disclaimerCollapse">
                    <div class="alert alert-warning" role="alert">
                        <h6>Use with care!</h6>
                        <p><small>
                            The NLQuery engine is capable of executing CRUD operations on your database. To mitigate potential risks and prevent unintended modifications, ensure that users have restricted privileges and proper access control mechanisms in place.
                        </small></p>
                        <h6>Data Privacy</h6>
                        <p><small>
                            Neither the NLQuery API nor the web interface stores any user-related data, query history, or session information on our servers. We do not monitor, log, or retain any generated SQL queries.

To enhance response quality, your generated SQL history is temporarily stored only in a client-side variable within your browser. This data is not saved in local storage, cookies, or any persistent storage, and it is lost when the page is refreshed or closed.

                        <h6>Liability Disclaimer</h6>
                        <p><small>We are not responsible for any unintended modifications, data loss, or security risks resulting from the use of this application. Users are solely responsible for managing their database permissions and the result of the SQL query that has been executed on your database. Use at your own risk.</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="tabular_output">
        
    </div>
    
    <!-- Bootstrap JS -->
    <script src="bootstrap.bundle.min.js"></script>
    <div class="container text-center fixed-bottom mb-3">
        <small><small>Powered by <a href="https://github.com/Emreerdog/mbase">MBASE SDK</a></small></small>
    </div>
</body>
<script>
    let sqlHistory = new Array;

    function displayTabularData(in_query_result)
    {
        let table = document.createElement("table");
        table.className = "table";

        let thead = document.createElement("thead");
        let headerRow = document.createElement("tr");
        let columns = Object.keys(in_query_result);
        columns.forEach(col => {
            let th = document.createElement("th");
            th.scope = "col";
            th.innerText = col;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        let tbody = document.createElement("tbody");
        tbody.className = "table-group-divider";

        let numRows = in_query_result[columns[0]].length;

        for (let i = 0; i < numRows; i++) {
            let tr = document.createElement("tr");

            columns.forEach(col => {
                let td = document.createElement("td");
                td.innerText = in_query_result[col][i];
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        }
        let tabularOutputSection = document.getElementById("tabular_output");
        tabularOutputSection.innerHTML = "";
        table.appendChild(tbody);
        tabularOutputSection.appendChild(table);
    }

    function writingQuery(self_form)
    {
        let queryButton = document.getElementById("sendQueryButton");   
        if(self_form.value.length)
        {
            queryButton.className = "btn btn-default";
        }
        else
        {
            queryButton.className = "btn btn-default disabled";
        }
    }

    function showInputFeedback(in_feedback_message)
    {
        let inputFeedbackContainer = document.getElementById("input_feedback");
        inputFeedbackContainer.innerHTML = in_feedback_message;
        inputFeedbackContainer.style.display = "block";
    }

    function showNlqueryError(in_status_code)
    {
        let nlQueryMessage = "Unknown status";
        if(in_status_code == 1)
        {
            nlQueryMessage = "Engine overloaded";
        }

        else if(in_status_code == 2)
        {
            nlQueryMessage = "DB Connection failed";
        }

        else if(in_status_code == 3)
        {
            nlQueryMessage = "Prompt invalid";
        }

        else if(in_status_code == 4)
        {
            nlQueryMessage = "Internal server error";
        }

        else if(in_status_code == 5)
        {
            nlQueryMessage = "Invalid payload";
        }

        else if(in_status_code == 6)
        {
            nlQueryMessage = "Provider not supported";
        }

        else if(in_status_code == 7)
        {
            nlQueryMessage = "DB failed to execute SQL"
        }

        else if(in_status_code == 8)
        {
            nlQueryMessage = "Input too long";
        }
        let tabularOutput = document.getElementById("tabular_output");
        tabularOutput.innerHTML = `<div class="alert alert-danger w-50" role="alert" style="margin:auto" id="nlquery_feedback">
            NLQuery failed<br>
            Status: ${nlQueryMessage}
        </div>`;
    }

    function showNlqUpdated(generatedQuery)
    {
        let tabularOutput = document.getElementById("tabular_output");
        tabularOutput.innerHTML = `<div class="alert alert-success w-50" role="alert" style="margin:auto" id="nlquery_feedback">
            NLQuery Success<br>
            Status: Query generated! If generate_only is false, given query is executed on the database:<br><br>
            <h6>${generatedQuery}</h6>
        </div>`;
    }

    function sendQueryRequest()
    {
        let inputFeedbackContainer = document.getElementById("input_feedback");
        inputFeedbackContainer.style.display = "none";

        let databaseUsername = document.getElementById("db_username").value;
        let databasePassword = document.getElementById("db_password").value;
        const userQuery = document.getElementById("nl_query").value;
        const genOnly = document.getElementById("gen_only").checked;

        let myArray = Array();

        let jsonToSend = {
            "query" : userQuery,
            "generate_only": genOnly
        };

        let chatHistorySection = document.getElementById("chatSection");
        chatHistorySection.innerHTML += `
            <div class="card-body">
                ${userQuery}
            </div>
        `;

        if(databaseUsername.length)
        {
            jsonToSend["db_username"] = databaseUsername;
        }

        if(databasePassword.length)
        {
            jsonToSend["db_password"] = databasePassword;
        }

        if(document.getElementById("remember_context").checked == true)
        {
            jsonToSend["sql_history"] = sqlHistory;
        }

        let tabularOutput = document.getElementById("tabular_output");
        tabularOutput.innerHTML = `<div class='d-flex justify-content-center align-items-center'>
            <div class='spinner-border' role='status'>
              <span class='visually-hidden'></span>
            </div>
        </div>`;

        document.getElementById("sendQueryButton").className = "btn btn-default disabled";
        document.getElementById("nl_query").setAttribute("disabled", "");
        document.getElementById("nl_query").value = "";

        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            let queryResult = JSON.parse(this.responseText);
            document.getElementById("nl_query").removeAttribute("disabled");
            if(queryResult.status != 0 && queryResult.status != 9)
            {
                showNlqueryError(queryResult.status);
            }
            else
            {
                
                if(sqlHistory.length == 5)
                {
                    sqlHistory.shift();
                }
                
                const sqlHistoryObject = {
                    "query_old" : userQuery,
                    "sql" : queryResult.sql
                };

                sqlHistory.push(sqlHistoryObject);

                if(queryResult.status == 9)
                {
                    showInputFeedback("Query returned more than 1000 rows, rest won't be displayed.");
                }

                // display the tables
                if(queryResult.data)
                {
                    displayTabularData(queryResult.data);
                }
                else
                {
                    showNlqUpdated(queryResult.sql);
                }
            }
        }
        xhttp.open("POST", "/nlquery", true);
        xhttp.send(JSON.stringify(jsonToSend));
    }
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
</script>
</html>
